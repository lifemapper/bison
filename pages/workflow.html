

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AWS workflow &mdash; LmBISON documentation 1.0a1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=036e6a88"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="AWS Resource Setup" href="aws/aws_setup.html" />
    <link rel="prev" title="About" href="about.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            LmBISON documentation
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="about.html">About</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">AWS workflow</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#get-ancillary-data">Get ancillary data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#annotate-riis-data-with-gbif-accepted-taxa">Annotate RIIS Data with GBIF Accepted Taxa</a></li>
<li class="toctree-l2"><a class="reference internal" href="#resolve-riis-data">Resolve RIIS data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#load-ancillary-data">Load ancillary data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#subset-gbif-data">Subset GBIF data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#troubleshooting">Troubleshooting</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#pad">PAD</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="aws/aws_setup.html">AWS Resource Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="aws/ec2_setup.html">EC2 instance creation</a></li>
<li class="toctree-l1"><a class="reference internal" href="aws/lambda.html">Create lambda function to initiate processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="aws/lambda.html#edit-the-configuration-for-lambda-function">Edit the Configuration for lambda function</a></li>
<li class="toctree-l1"><a class="reference internal" href="aws/lambda.html#lambda-to-query-redshift">Lambda to query Redshift</a></li>
<li class="toctree-l1"><a class="reference internal" href="aws/lambda.html#lambda-to-start-ec2-for-task">Lambda to start EC2 for task</a></li>
<li class="toctree-l1"><a class="reference internal" href="aws/roles.html">Roles, Policies, Trust Relationships</a></li>
<li class="toctree-l1"><a class="reference internal" href="aws/automation.html">Workflow Automation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="interaction/debug.html">Debugging Flask and Docker instances</a></li>
<li class="toctree-l1"><a class="reference internal" href="interaction/deploy.html">Deploy BISON</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="history/year4_planB.html">Year 4, Part 2, 2023-2024</a></li>
<li class="toctree-l1"><a class="reference internal" href="history/year4_planA.html">Year 4, Part 1, 2023</a></li>
<li class="toctree-l1"><a class="reference internal" href="history/year3.html">Year 3, 2021-2022</a></li>
<li class="toctree-l1"><a class="reference internal" href="history/year5.html">Year 5, 2024</a></li>
<li class="toctree-l1"><a class="reference internal" href="history/aws_experiments.html">AWS workflow experiments</a></li>
<li class="toctree-l1"><a class="reference internal" href="history/aws_experiments.html#glue-interactive-development">Glue - Interactive Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="history/aws_experiments.html#bison-aws-data-tools">BISON AWS data/tools</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">LmBISON documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">AWS workflow</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/pages/workflow.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="aws-workflow">
<h1>AWS workflow<a class="headerlink" href="#aws-workflow" title="Link to this heading"></a></h1>
<section id="get-ancillary-data">
<h2>Get ancillary data<a class="headerlink" href="#get-ancillary-data" title="Link to this heading"></a></h2>
<ul>
<li><p>Census data at
<a class="reference external" href="https://www.census.gov/geographies/mapping-files/time-series/geo/cartographic-boundary.html">https://www.census.gov/geographies/mapping-files/time-series/geo/cartographic-boundary.html</a></p>
<ul class="simple">
<li><p>Use 1:500,000 (or finer) where available</p></li>
<li><p>Use most current year (currently 2023)</p></li>
<li><p>All data is in Geographic coordinate reference system (EPSG:4326), which
matches the coordinates in GBIF records</p></li>
<li><p>US County Boundaries, 1:500,000, cb_2023_us_county_500k.shp</p></li>
<li><p>American Indian/Alaska Native Areas/Hawaiian Home Lands, AIANNH, 1:500,000,
cb_2023_us_aiannh_500k.zip</p></li>
</ul>
</li>
<li><p>Protected Areas Database (PAD) at
<a class="reference external" href="https://www.usgs.gov/programs/gap-analysis-project/science/pad-us-data-download">https://www.usgs.gov/programs/gap-analysis-project/science/pad-us-data-download</a></p>
<ul class="simple">
<li><p>PAD-US Vector Analysis Files
These are “flattened” though spatial analysis prioritized by GAP Status Code
(ie GAP 1 &gt; GAP 2 &gt; GAP &gt; 3 &gt; GAP 4), these are found on bottom of page</p></li>
<li><p>The Vector data is an ESRI geodatabase, accessible through GDAL/OGR using the
OpenFileGDB driver.</p></li>
<li><p>Data is in EPSG:102039 - USA Contiguous Albers Equal Area Conic - USGS Version</p></li>
<li><p>Prepare the data for AWS</p>
<ul>
<li><p>Download the vector file PADUS4_0VectorAnalysis_GAP_PADUS_Only_ClipCENSUS.zip
for Alaska, Hawaii, continental US.</p></li>
<li><p>Unzip locally to PADUS4_0VectorAnalysis_GAP_PADUS_Only_ClipCENSUS.gdb, a
directory containing a geodatabase.</p></li>
</ul>
</li>
</ul>
</li>
<li><p>USGS Registry of Introduced and Invasive Species</p>
<ul>
<li><p>Current data, version 2, is from 2022:</p>
<ul>
<li><p><a class="reference external" href="https://www.sciencebase.gov/catalog/item/62d59ae5d34e87fffb2dda99">https://www.sciencebase.gov/catalog/item/62d59ae5d34e87fffb2dda99</a></p></li>
<li><p><a class="reference external" href="https://www.invasivespeciesinfo.gov/resource/11555">https://www.invasivespeciesinfo.gov/resource/11555</a></p></li>
<li><p>Simpson, A., Fuller, P., Faccenda, K., Evenhuis, N., Matsunaga, J., and
Bowser, M., 2022, United States Register of Introduced and Invasive Species
(US-RIIS) (ver. 2.0, November 2022): U.S. Geological Survey data release,
<a class="reference external" href="https://doi.org/10.5066/P9KFFTOD">https://doi.org/10.5066/P9KFFTOD</a>.</p></li>
<li><p>Data files:
* USRIISv2_MasterList.csv: contains a record for any species determined to be</p>
<blockquote>
<div><p>Introduced or Invasive for a US region.  Regions are limited to Alaska, Hawaii,
and the Continental US (AK, HI, L48). A species may be designated as Introduced or
Invasive for one or more of these regions, with a record for each.</p>
</div></blockquote>
<ul class="simple">
<li><p>USRIISv2_AuthorityReferences.csv: contains citations for the RIIS designations
in the MasterList.</p></li>
<li><p>US-RIISv2_DataDictionary.csv: contains full descriptions of the data in each
field in the MasterList.</p></li>
</ul>
</li>
<li><p>Categories in establishmentMeans field are:</p>
<ul class="simple">
<li><p>introduced (alien, exotic, non-native, nonindigenous)</p></li>
<li><p>introduced: assisted colonization</p></li>
<li><p>introduced (alien, exotic, non-native, nonindigenous); introduced: assisted colonization</p></li>
</ul>
</li>
<li><p>Categories in degreeOfEstablishment field are:</p>
<ul class="simple">
<li><p>established (category C3)</p></li>
<li><p>invasive (category D2)</p></li>
<li><p>widespread invasive (category E)</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</section>
<section id="annotate-riis-data-with-gbif-accepted-taxa">
<h2>Annotate RIIS Data with GBIF Accepted Taxa<a class="headerlink" href="#annotate-riis-data-with-gbif-accepted-taxa" title="Link to this heading"></a></h2>
<p>Run bison/tools/annotate_riis.py to annotate the file with the GBIF taxonKey and
scientificName for the currently accepted name for each record.  The annotated file
will be created in the same directory, and have the basename appended with
“_annotated_yyyy_mm_dd.csv” where yyyy_mm_dd is the first day of the current month.
This ensures that the RIIS data and the current GBIF data that have the same date
appended and taxonomic resolutions are current.</p>
</section>
<section id="resolve-riis-data">
<h2>Resolve RIIS data<a class="headerlink" href="#resolve-riis-data" title="Link to this heading"></a></h2>
<p>Add GBIF accepted taxa to RIIS data records of RIIS introduced/invasive status for
species by region (AK, HI, L48).  This provides a field to match on, as all GBIF records
include the accepted taxon.</p>
<p>This step is initiated by an EventBridge Schedule, and:</p>
<ul class="simple">
<li><p>Creates and launches an EC2 instance</p></li>
<li><p>The “userdata” in the EC2 instance runs a script which:</p>
<ul>
<li><p>pulls a Docker image containing BISON code from the Specify Docker Hub</p></li>
<li><p>starts the Docker instance</p></li>
<li><p>initiates the “annotate_riis” command.</p></li>
<li><p>when the annotation is complete, it uploads the annotated RIIS file to S3</p></li>
</ul>
</li>
<li><p>TODO: The update of the annotated RIIS file on S3 is an event which triggers:</p>
<ul>
<li><p>stop the EC2 instance.</p></li>
<li><p>initiate the next step.</p></li>
</ul>
</li>
</ul>
</section>
<section id="load-ancillary-data">
<h2>Load ancillary data<a class="headerlink" href="#load-ancillary-data" title="Link to this heading"></a></h2>
<ul>
<li><p>Census data:</p>
<ul>
<li><p>upload all files associated with a shapefile to S3</p></li>
<li><p>Look at the metadata using ogrinfo.  The <cite>-al</cite> switch indicates all layers,
<cite>-so</cite> suppresses printing all features:</p>
<p>ogrinfo -al -so -geom=SUMMARY cb_2023_us_aiannh_500k.shp
ogrinfo -al -so -geom=SUMMARY cb_2023_us_county_500k.shp</p>
</li>
<li><p>Check and modify fields in the appropriate <cite>CREATE TABLE</cite> command in the
aws/redshift/load_ancillary_data.sql script.</p></li>
<li><p>Run the <cite>CREATE TABLE</cite> command to create an empty table in Redshift,
and the following <cite>COPY</cite> command to load the data into Redshift.</p></li>
</ul>
</li>
<li><p>Annotated RIIS data</p>
<ul class="simple">
<li><p>upload the annotated RIIS CSV file to S3.</p></li>
</ul>
</li>
</ul>
</section>
<section id="subset-gbif-data">
<h2>Subset GBIF data<a class="headerlink" href="#subset-gbif-data" title="Link to this heading"></a></h2>
<p>The scripts for the following steps are in aws/redshift:</p>
<ol class="arabic simple">
<li><p><strong>subset_gbif.sql</strong>: Load a subset of the latest GBIF data into Redshift</p>
<ul class="simple">
<li><p>If doing in the Query Editor, choose the <cite>bison</cite> workgroup/namespace, and the
<cite>dev</cite> database in the top left section of the interface.</p></li>
<li><p>Mount GBIF Open Data Registry on S3 to Redshift in an external schema
(redshift_spectrum) in the dev database. (21sec)</p></li>
<li><p>Subset to US, with coordinates, Rank is Species or below, limited BasisOfRecord,
with minimal fields (may rejoin other fields after Redshift steps) to create new
table in public schema in dev database.  Subsets from 3 billion records to
1 billion, 1.1min</p></li>
<li><p>Output is in the <cite>bison</cite> workgroup/namespace, in the <cite>dev</cite> database, <cite>public</cite>
schmema, and named like bison_YYYY_MM_DD, with the date string indicating the most
recent GBIF data on Amazon ODR.</p></li>
</ul>
</li>
</ol>
</section>
<section id="troubleshooting">
<h2>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Link to this heading"></a></h2>
<section id="pad">
<h3>PAD<a class="headerlink" href="#pad" title="Link to this heading"></a></h3>
<ul>
<li><p>Look at the metadata using ogrinfo:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ogrinfo</span> <span class="o">-</span><span class="n">al</span> <span class="o">-</span><span class="n">so</span> <span class="o">-</span><span class="n">geom</span><span class="o">=</span><span class="n">SUMMARY</span> <span class="n">PADUS4_0VectorAnalysis_GAP_PADUS_Only_ClipCENSUS</span><span class="o">.</span><span class="n">gdb</span>
</pre></div>
</div>
</li>
<li><p>Subset the geodatabase into shapefile, each with a GAP status of 1 or 2:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ogr2ogr</span> \
    <span class="o">-</span><span class="n">of</span> <span class="s2">&quot;ESRI Shapefile&quot;</span> \
    <span class="o">-</span><span class="n">progress</span> \
    <span class="o">-</span><span class="n">skipfailures</span> \
    <span class="o">-</span><span class="n">where</span> <span class="s2">&quot;GAP_Sts = &#39;1&#39;&quot;</span> \
    <span class="n">pad_4</span><span class="mf">.0</span><span class="n">_gap1b</span><span class="o">.</span><span class="n">shp</span>  <span class="n">PADUS4_0VectorAnalysis_GAP_PADUS_Only_ClipCENSUS</span><span class="o">.</span><span class="n">gdb</span>  \
    <span class="o">-</span><span class="n">nlt</span> <span class="n">polygon</span> \
    <span class="o">-</span><span class="n">lco</span> <span class="n">ENCODING</span><span class="o">=</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span>

    <span class="o">-</span><span class="n">where</span> <span class="s2">&quot;GAP_Sts = &#39;1&#39; OR GAP_Sts = &#39;2&#39;&quot;</span> \
    <span class="o">-</span><span class="n">select</span> <span class="n">SHAPE</span><span class="p">,</span><span class="n">OBJECTID</span><span class="p">,</span><span class="n">Mang_Type</span><span class="p">,</span><span class="n">Mang_Name</span><span class="p">,</span><span class="n">Loc_Ds</span><span class="p">,</span><span class="n">Unit_Nm</span><span class="p">,</span><span class="n">GAP_Sts</span><span class="p">,</span><span class="n">GIS_Acres</span> \
</pre></div>
</div>
</li>
<li><p>Reproject each shapefile to EPSG:4326:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ogr2ogr</span> \
    <span class="o">-</span><span class="n">of</span> <span class="s2">&quot;ESRI Shapefile&quot;</span> \
    <span class="o">-</span><span class="n">t_srs</span> <span class="s2">&quot;EPSG:4326&quot;</span> \
    <span class="n">pad_4</span><span class="mf">.0</span><span class="n">_gap1_4326</span><span class="o">.</span><span class="n">shp</span>  <span class="n">pad_4</span><span class="mf">.0</span><span class="n">_gap1</span><span class="o">.</span><span class="n">shp</span> \
    <span class="o">-</span><span class="n">lco</span> <span class="n">ENCODING</span><span class="o">=</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span>
</pre></div>
</div>
</li>
<li><p>Create an empty table in Redshift:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CREATE</span> <span class="n">TABLE</span> <span class="n">pad1</span> <span class="p">(</span>
   <span class="n">SHAPE</span>     <span class="n">GEOMETRY</span><span class="p">,</span>
   <span class="n">OBJECTID</span>  <span class="n">INTEGER</span><span class="p">,</span>
   <span class="n">Mang_Type</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="nb">max</span><span class="p">),</span>
   <span class="n">Mang_Name</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="nb">max</span><span class="p">),</span>
   <span class="n">Loc_Ds</span>    <span class="n">VARCHAR</span><span class="p">(</span><span class="nb">max</span><span class="p">),</span>
   <span class="n">Unit_Nm</span>   <span class="n">VARCHAR</span><span class="p">(</span><span class="nb">max</span><span class="p">),</span>
   <span class="n">GAP_Sts</span>   <span class="n">VARCHAR</span><span class="p">(</span><span class="nb">max</span><span class="p">),</span>
   <span class="n">GIS_Acres</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="nb">max</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>Fill table from S3:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">COPY</span> <span class="n">pad1</span> <span class="n">FROM</span> <span class="s1">&#39;s3://bison-321942852011-us-east-1/input_data/pad_4.0_gap1_4326.shp&#39;</span>
<span class="n">FORMAT</span> <span class="n">SHAPEFILE</span>
<span class="n">SIMPLIFY</span> <span class="n">AUTO</span>
<span class="n">IAM_role</span> <span class="n">DEFAULT</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p>Always error, even when reducing the number of records or using all fields:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Compass</span> <span class="n">I</span><span class="o">/</span><span class="n">O</span> <span class="n">exception</span><span class="p">:</span> <span class="n">Invalid</span> <span class="n">hexadecimal</span> <span class="n">character</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">found</span>
</pre></div>
</div>
</li>
</ul>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="about.html" class="btn btn-neutral float-left" title="About" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="aws/aws_setup.html" class="btn btn-neutral float-right" title="AWS Resource Setup" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, LmBISON Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>