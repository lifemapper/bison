

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AWS workflow experiments &mdash; LmBISON documentation 1.0a1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=036e6a88"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="prev" title="Year 5, 2024" href="year5.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            LmBISON documentation
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../workflow.html">AWS workflow</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../aws/aws_setup.html">AWS Resource Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aws/ec2_setup.html">EC2 instance creation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aws/lambda.html">Create lambda function to initiate processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aws/lambda.html#edit-the-configuration-for-lambda-function">Edit the Configuration for lambda function</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aws/lambda.html#lambda-to-query-redshift">Lambda to query Redshift</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aws/lambda.html#lambda-to-start-ec2-for-task">Lambda to start EC2 for task</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aws/roles.html">Roles, Policies, Trust Relationships</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aws/automation.html">Workflow Automation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../interaction/debug.html">Debugging Flask and Docker instances</a></li>
<li class="toctree-l1"><a class="reference internal" href="../interaction/deploy.html">Deploy BISON</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="year4_planB.html">Year 4, Part 2, 2023-2024</a></li>
<li class="toctree-l1"><a class="reference internal" href="year4_planA.html">Year 4, Part 1, 2023</a></li>
<li class="toctree-l1"><a class="reference internal" href="year3.html">Year 3, 2021-2022</a></li>
<li class="toctree-l1"><a class="reference internal" href="year5.html">Year 5, 2024</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">AWS workflow experiments</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#aws-batch">AWS Batch</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#old-workflow">Old Workflow:</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#glue-interactive-development">Glue - Interactive Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="#bison-aws-data-tools">BISON AWS data/tools</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">LmBISON documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">AWS workflow experiments</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/pages/history/aws_experiments.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="aws-workflow-experiments">
<h1>AWS workflow experiments<a class="headerlink" href="#aws-workflow-experiments" title="Link to this heading"></a></h1>
<section id="aws-batch">
<h2>AWS Batch<a class="headerlink" href="#aws-batch" title="Link to this heading"></a></h2>
<section id="overview">
<h3>Overview<a class="headerlink" href="#overview" title="Link to this heading"></a></h3>
<ol class="arabic">
<li><p>Getting started</p>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.aws.amazon.com/batch/latest/userguide/Batch_GetStarted.html">https://docs.aws.amazon.com/batch/latest/userguide/Batch_GetStarted.html</a></p></li>
<li><p>All these steps are already completed, up to and including install aws_cli</p></li>
</ul>
</li>
<li><p>Create a VPC.</p>
<ul class="simple">
<li><p>The default one is fine for now</p></li>
</ul>
</li>
<li><p>Run AWS Batch first-run wizard to</p>
<ul>
<li><p>set up roles</p>
<p>Create role, include Batch permissions: AWSServiceRoleForBatch</p>
</li>
<li><p>create a compute environment (EC2)</p>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html">https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html</a></p></li>
<li><p>AWS Console, Services, AWS Batch
* choose EC2, r7g.medium AMI</p></li>
</ul>
</li>
<li><p>Create Batch resources</p></li>
<li><p>Select orchestration type (EC2)</p></li>
<li><p>Create a compute environment</p></li>
<li><p>Create a job queue</p></li>
<li><p>Create a job definition</p></li>
<li><p>Create a job</p></li>
<li><p>Review and create</p></li>
<li><p>create a job definition, and</p></li>
<li><p>create a job queue</p></li>
</ul>
</li>
<li><p>Docker image</p>
<ul class="simple">
<li><p>docker pull ghcr.io/osgeo/gdal:alpine-small-latest</p></li>
</ul>
</li>
</ol>
</section>
<section id="old-workflow">
<h3>Old Workflow:<a class="headerlink" href="#old-workflow" title="Link to this heading"></a></h3>
<p>Creates EC2 spot image to download requested data directly from GBIF, save to S3,
index in Glue database.</p>
<p>Prep:</p>
<ul class="simple">
<li><p>Create a Docker image from osgeo/gdal with
* python dependencies
* bison code
* reference data</p></li>
<li><p>Save on S3 or Github</p></li>
</ul>
<p>Input data acquisition:</p>
<ul class="simple">
<li><p>Create EC2 spot image</p>
<ul>
<li><p>download data from GBIF</p></li>
<li><p>copy to S3</p></li>
</ul>
</li>
</ul>
<p>Input data prep:
* Create a Step Workflow to:</p>
<blockquote>
<div><ul class="simple">
<li><p>crawl for metadata</p></li>
<li><p>copy to a Glue database</p></li>
<li><p>add annotation fields</p></li>
<li><p>count records and identify subsets</p></li>
</ul>
</div></blockquote>
<p>Batch:
* Create AWS Batch Compute Environment</p>
<blockquote>
<div><ul class="simple">
<li><p>name</p></li>
<li><p>with EC2 orchestration</p></li>
<li><p>Create AWSServiceRoleForBatch, and InstanceRole</p></li>
</ul>
</div></blockquote>
<ul class="simple">
<li><p>Create AWS Batch Job Queue</p>
<ul>
<li><p>Choose name, priority</p></li>
<li><p>Choose Batch Compute Environment from prev step</p></li>
</ul>
</li>
<li><p>Create AWS Batch Job Definition</p>
<ul>
<li><p>Job definition name</p></li>
<li><p>Job role</p></li>
<li><p>Container image: Specify the URL of your Docker image stored in an S3 bucket or a
public container registry.</p></li>
<li><p>Command: Define the command that should be executed within the container.</p></li>
</ul>
</li>
<li><p>Submit AWS Batch Job</p></li>
</ul>
</section>
</section>
</section>
<section id="glue-interactive-development">
<h1>Glue - Interactive Development<a class="headerlink" href="#glue-interactive-development" title="Link to this heading"></a></h1>
<p><a class="reference external" href="https://docs.aws.amazon.com/glue/latest/dg/create-notebook-job.html">AWS Glue Studio with Jupyter</a></p>
<p><a class="reference external" href="https://docs.aws.amazon.com/glue/latest/dg/aws-glue-programming-etl-format-parquet-home.html">Local development with Jupyter</a></p>
<p>Interactive Samples fail with error (File Not Found) for public GBIF data</p>
<ul class="simple">
<li><p>Create database in AWS Glue for metadata about project inputs</p>
<ul>
<li><p>In the DB, create table for each data input, using Glue Crawler</p></li>
</ul>
</li>
</ul>
<p>Interactive Data Preview fails for public and private data</p>
<ul class="simple">
<li><p>Use AWS Glue DataBrew to visually examine data</p>
<ul>
<li><dl class="simple">
<dt>First add dataset to Glue Data Catalog</dt><dd><p>“A table is the metadata definition that represents your data, including its
schema. A table can be used as a source or target in a job definition.”</p>
</dd>
</dl>
</li>
<li><p>Next add dataset to Glue DataBrew</p></li>
</ul>
</li>
</ul>
<p>AWS Glue DataBrew add dataset, create connection to RDS, shows no tables in
bison-metadata database.</p>
<p>DataBrew for visual representation of data, not examination</p>
</section>
<section id="bison-aws-data-tools">
<h1>BISON AWS data/tools<a class="headerlink" href="#bison-aws-data-tools" title="Link to this heading"></a></h1>
<blockquote>
<div><ul class="simple">
<li><p>Use Glue to Subset GBIF ODR data into local bucket</p></li>
<li><p>Crawl GBIF data s3://gbif-open-data-us-east-1/occurrence/2023-11-01/occurrence.parquet/
to create gbif-odr-occurrence_parquet table in Data Catalog tables</p></li>
</ul>
</div></blockquote>
<blockquote>
<div><ul>
<li><p>Create JDBC connection from Glue, then TestConnection</p>
<blockquote>
<div><p>InvalidInputException: VPC S3 endpoint validation failed for SubnetId:
subnet-xxx. VPC: vpc-xxx. Reason: Could not find
S3 endpoint or NAT gateway for subnetId: subnet-xxx in Vpc
vpc-xxx</p>
</div></blockquote>
</li>
</ul>
</div></blockquote>
<blockquote>
<div><ul class="simple">
<li><p>bison-metadata Database, populated by</p></li>
<li><p>AWS Glue Crawler, crawls data to create tables of metadata/schema
* GBIF Crawler to crawl GBIF Open Data Registry 11-2023 –&gt; gbif-odr-occurrence_parquet table
* Does Glue Crawler only access S3?</p></li>
</ul>
</div></blockquote>
<ul>
<li><p>To connect to RDS, add Glue/Data Catalog/Connection</p>
<blockquote>
<div><ul>
<li><p>endpoint: &lt;db_name&gt;.&lt;db_id&gt;.&lt;region&gt;.rds.amazonaws.com</p></li>
<li><p>dbname: &lt;db_name&gt;</p></li>
<li><dl class="simple">
<dt>connection url:</dt><dd><p><a class="reference external" href="jdbc:postgresql:/">jdbc:postgresql:/</a>/&lt;db_name&gt;.&lt;db_id&gt;.&lt;region&gt;.rds.amazonaws.com:5432/&lt;db_name&gt;</p>
</dd>
</dl>
</li>
<li><p>“InvalidInputException: Unable to resolve any valid connection”
Docs point to error logs in /aws-glue/testconnection/output, but this does not exist
check <a class="reference external" href="https://repost.aws/knowledge-center/glue-test-connection-failed">https://repost.aws/knowledge-center/glue-test-connection-failed</a></p></li>
<li><p>Added RDS database VPC, 1 subnet, all 3 security groups</p></li>
<li><dl class="simple">
<dt>Result: InvalidInputException:</dt><dd><p>At least one security group must open all ingress ports.To limit traffic, the
source security group in your inbound rule can be restricted to the same
security group</p>
</dd>
</dl>
</li>
<li><p>Added inbound and outbound rules to my security group for postgresql, same error</p>
<blockquote>
<div><p>Add policy to my user:
<a class="reference external" href="https://docs.aws.amazon.com/glue/latest/dg/configure-iam-for-glue.html">https://docs.aws.amazon.com/glue/latest/dg/configure-iam-for-glue.html</a>
Added policy according to instructions in Step 3, verbatim -
Error:</p>
</div></blockquote>
</li>
</ul>
</div></blockquote>
</li>
</ul>
<p>Add AdministratorAccess  to Role, the audit the calls later to identify
minimum permissions needed.</p>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="year5.html" class="btn btn-neutral float-left" title="Year 5, 2024" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, LmBISON Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>